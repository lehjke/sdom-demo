stages:
  - build
  - security

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "-B -ntp -DskipTests"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - when: never

cache:
  key: "${CI_PROJECT_ID}"
  paths:
    - .m2/repository

generate_sbom:
  stage: build
  image: maven:3.9.9-eclipse-temurin-21
  script:
    - mvn $MAVEN_CLI_OPTS org.cyclonedx:cyclonedx-maven-plugin:2.8.1:makeAggregateBom
    - ls -la target || true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/bom.json
      - target/bom.xml

dependency_check:
  stage: security
  image: maven:3.9.9-eclipse-temurin-21
  script:
    - mvn $MAVEN_CLI_OPTS org.owasp:dependency-check-maven:10.0.4:check
    - ls -la target || true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - target/dependency-check-report.html
      - target/dependency-check-report.json
      - target/dependency-check-report.xml
      - target/dependency-check-report.csv
      - target/dependency-check-report.sarif
  allow_failure: true

upload_to_dependencytrack:
  stage: security
  image: curlimages/curl:8.10.1
  needs: ["generate_sbom"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
  script:
    - test -n "$DTRACK_URL"
    - test -n "$DTRACK_API_KEY"
    - test -n "$DTRACK_PROJECT_UUID"
    - test -f target/bom.json
    - >
      curl -sS -X POST "$DTRACK_URL/api/v1/bom" \
        -H "X-Api-Key: $DTRACK_API_KEY" \
        -H "Content-Type: multipart/form-data" \
        -F "project=$DTRACK_PROJECT_UUID" \
        -F "autoCreate=false" \
        -F "bom=@target/bom.json"
  allow_failure: true
