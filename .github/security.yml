name: SBOM + Dependency-Track + Dependency-Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-sbom:
    name: build (generate SBOM)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java (Microsoft OpenJDK 25)
        uses: actions/setup-java@v4
        with:
          distribution: microsoft
          java-version: "25"
          cache: maven

      - name: Generate CycloneDX SBOM
        run: |
          mvn -B -DskipTests \
            org.cyclonedx:cyclonedx-maven-plugin:2.9.0:makeAggregateBom

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: |
            target/bom.json
            target/bom.xml
          retention-days: 7

  security:
    name: security (dtrack upload + depcheck)
    runs-on: ubuntu-latest
    needs: build-sbom

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom

      - name: Upload BOM to Dependency-Track
        env:
          DTRACK_URL: ${{ vars.DTRACK_URL }}
          DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
          DTRACK_PROJECT_NAME: sbom-demo
          DTRACK_PROJECT_VERSION: "1.0"
        run: |
          set -euo pipefail

          BOM_FILE=""
          if [ -f "sbom/target/bom.json" ]; then BOM_FILE="sbom/target/bom.json"; fi
          if [ -z "$BOM_FILE" ] && [ -f "sbom/bom.json" ]; then BOM_FILE="sbom/bom.json"; fi
          if [ -z "$BOM_FILE" ] && [ -f "sbom/bom.xml" ]; then BOM_FILE="sbom/bom.xml"; fi

          if [ -z "$BOM_FILE" ]; then
            echo "SBOM file not found in artifact."
            ls -la sbom || true
            exit 1
          fi

          echo "Using BOM: $BOM_FILE"

          # Create / update project and upload BOM (v1 API)
          curl -sS -X PUT "${DTRACK_URL}/api/v1/project" \
            -H "X-Api-Key: ${DTRACK_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"${DTRACK_PROJECT_NAME}\",\"version\":\"${DTRACK_PROJECT_VERSION}\"}"

          curl -sS -X POST "${DTRACK_URL}/api/v1/bom" \
            -H "X-Api-Key: ${DTRACK_API_KEY}" \
            -F "projectName=${DTRACK_PROJECT_NAME}" \
            -F "projectVersion=${DTRACK_PROJECT_VERSION}" \
            -F "bom=@${BOM_FILE}"

      - name: Set up Java (17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Dependency-Check (HTML + JSON reports)
        run: |
          mvn -B -DskipTests \
            org.owasp:dependency-check-maven:12.1.9:check \
            -Dformat=ALL \
            -DoutputDirectory=dependency-check-report

      - name: Upload Dependency-Check report artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report
          retention-days: 7